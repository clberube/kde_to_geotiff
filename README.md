# KDE-to-GeoTIFF

Compute a spatial kernel density estimation (KDE) from point shapefiles and export it as a GeoTIFF.

This command-line tool reads a shapefile containing point geometries, computes a KDE over a regular grid, and saves the result as a single-band GeoTIFF with transparent pixels outside a chosen distance.  
It is ideal for creating density maps of sampling sites, mineral occurrences, or other spatial point datasets.

---

## Features

- Reads any shapefile with point, line, or polygon geometries  
- Automatically projects geographic data to an appropriate UTM CRS  
- Uses a Gaussian kernel  
- Exports a GeoTIFF with nodata transparency (no `.msk` sidecar files)  
- User-defined bandwidth (`--kernel-size`) and grid resolution (`--pixel-size`)  
- Optional convex-hull clipping to limit density to the study area  
- Optional filtering based on a specific attribute (`--data-column`)
- Optional soil horizon filtering using `--horizon-column` and `--horizon-keep`
- KDE computed with SciPy’s `gaussian_kde`
- Fast batched KDE evaluation with a progress bar (via `tqdm`)
- Uses a Gaussian kernel and outputs a min–max scaled density between 0 and 1


---

## Installation

```bash
git clone https://github.com/clberube/kde_to_geotiff
cd kde_to_geotiff
pip install -r requirements.txt
```

### Requirements

```
geopandas  
rasterio  
numpy  
scipy  
pyproj  
shapely  
tqdm
```

You can also install them manually with conda:

```bash
conda install geopandas rasterio numpy scikit-learn scipy pyproj shapely
```

---

## Usage

```bash
python kde_to_geotiff.py input_points.shp output_kde.tif --pixel-size 25 --kernel-size 0.1 
```

### Arguments

| Argument | Required | Description |
|-----------|-----------|-------------|
| `input_shapefile` | ✅ | Path to the input shapefile (points preferred) |
| `output_geotiff` | ✅ | Path to the output GeoTIFF |
| `--pixel-size` | ✅ | Pixel size for the output grid (in same units) |
| `--kernel-size` | optional | KDE bandwidth as a fraction of Scott's rule (default: 0.1) |
| `--to-crs` | optional | EPSG code or PROJ string for reprojection (auto-UTM if omitted) |
| `--clip-to-hull` | optional | If set, clip the KDE to the convex hull of the input geometries (expanded by kernel_size). |
| `--data-column` | optional | Name of a column used to filter points; only rows with non-missing values in that column are included in the KDE (default: `None`) |
| `--horizon-column` | optional | Name of a column used to filter samples based on soil horizon (e.g., `"HORIZON"`). |
| `--horizon-keep`   | required only if `--horizon-column` is provided | One or more horizon labels to keep (e.g., `A`, `B`, or `A B`). Samples belonging to other horizons are discarded. |
| `--remove-negative` | optional | Remove rows where the value in `--data-column` is negative (`< 0`). |
| `--remove-positive` | optional | Remove rows where the value in `--data-column` is positive (`> 0`). |


---

## Examples

### 1. Basic Gaussian KDE
```bash
python kde_to_geotiff.py samples.shp density.tif --pixel-size 30
```

### 2. Basic Gaussian KDE for Barium only
```bash
python kde_to_geotiff.py samples.shp density.tif --pixel-size 30 --data-column "Ba_ppm" 
```

### 3. Custom kernel size and reprojection to Québec Lambert CRS
```bash
python kde_to_geotiff.py samples.shp density.tif --kernel-size 0.3 --pixel-size 20 --to-crs EPSG:32198
```

### 4. Clip the raster to the convex hull
```bash
python kde_to_geotiff.py samples.shp density.tif --pixel-size 25 --clip-to-hull
```

### 5. Filter by soil horizon

**Keep only samples from horizon A:**
```bash
python kde_to_geotiff.py samples.shp density_A.tif --pixel-size 20 --horizon-column "HORIZON" --horizon-keep A
```

**Keep horizons A and B:**
```bash
python kde_to_geotiff.py samples.shp density_AB.tif --pixel-size 20 --horizon-column "HORIZON" --horizon-keep A B
```

### 6. Remove negative or positive values

**Remove negative values (keep only ≥ 0):**
```bash
python kde_to_geotiff.py samples.shp density_pos.tif --pixel-size 25 --data-column Ba_ppm --remove-negative
```

**Remove positive values (keep only ≤ 0):**
```bash
python kde_to_geotiff.py samples.shp density_neg.tif --pixel-size 25 --data-column Ba_ppm --remove-positive
```

---

## Output

- Single-band GeoTIFF (`float32`)
- CRS automatically set from input or auto-UTM projection  
- `nodata = -9999` pixels are transparent in QGIS or any GIS  
- KDE values are min–max scaled to the [0, 1] range for visualization.
  (The KDE output is not a true probability density function.)
- The KDE evaluation is performed in batches to reduce memory usage on large grids.

---

## License

This project is released under the MIT License.  
Feel free to use, modify, and distribute it.

---

## Authors

**Prof. Charles L. Bérubé**  
ΦRe(x) - Polytechnique Montréal  
Montréal, Québec, Canada  
README file generated by ChatGPT. 
