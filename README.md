# KDE-to-GeoTIFF

Compute a spatial kernel density estimation (KDE) from point shapefiles and export it as a GeoTIFF.

This command-line tool reads a shapefile containing point geometries, computes a kernel density estimate (KDE) over a regular grid, and saves the result as a single-band GeoTIFF with transparent pixels outside a chosen distance.  
It is ideal for creating density maps of sampling sites, mineral occurrences, or other spatial point datasets.

---

## Features

- Reads any shapefile with point, line, or polygon geometries  
- Automatically projects geographic data to an appropriate UTM CRS  
- Supports multiple kernel functions (Gaussian, Epanechnikov, tophat, etc.)  
- Exports a GeoTIFF with nodata transparency (no `.msk` sidecar files)  
- User-defined bandwidth (`--kernel-size`) and grid resolution (`--pixel-size`)  
- Optional convex-hull clipping to limit density to the study area  

---

## Installation

```bash
git clone https://github.com/clberube/kde_to_geotiff
cd kde_to_geotiff
pip install -r requirements.txt
```

### Requirements

```
geopandas
rasterio
numpy
scikit-learn
scipy
pyproj
shapely
```

You can also install them manually with conda:

```bash
conda install geopandas rasterio numpy scikit-learn scipy pyproj shapely
```

---

## Usage

```bash
python kde_to_geotiff.py input_points.shp output_kde.tif --kernel-size 250 --pixel-size 25
```

### Arguments

| Argument | Required | Description |
|-----------|-----------|-------------|
| `input_shapefile` | ✅ | Path to the input shapefile (points preferred) |
| `output_geotiff` | ✅ | Path to the output GeoTIFF |
| `--kernel-size` | ✅ | KDE bandwidth in CRS units (e.g., meters) |
| `--pixel-size` | ✅ | Pixel size for the output grid (in same units) |
| `--kernel` | optional | Kernel type: `gaussian`, `tophat`, `epanechnikov`, `exponential`, `linear`, `cosine` (default: `gaussian`) |
| `--to-crs` | optional | EPSG code or PROJ string for reprojection (auto-UTM if omitted) |
| `--clip-padding` | optional | Expand grid bounds by N × kernel_size (default: `1.0`) |
| `--data-column` | optional | Name of a column used to filter points; only rows with non-missing values in that column are included in the KDE (default: `None`) |
---

## Examples

**1. Basic Gaussian KDE**
```bash
python kde_to_geotiff.py samples.shp density.tif     --kernel-size 300 --pixel-size 30
```

**2. Basic Gaussian KDE for Barium only**
```bash
python kde_to_geotiff.py samples.shp density.tif     --kernel-size 300 --pixel-size 30 --data-column "Ba_ppm"
```

**3. Localized Epanechnikov kernel with Québec Lambert CRS**
```bash
python kde_to_geotiff.py samples.shp density.tif     --kernel-size 200 --pixel-size 20 --kernel epanechnikov --to-crs EPSG:32198
```

**4. Add padding to avoid edge effects**
```bash
python kde_to_geotiff.py samples.shp density.tif     --kernel-size 250 --pixel-size 25 --clip-padding 1.5
```

---

## Output

- Single-band GeoTIFF (`float32`)
- CRS automatically set from input or auto-UTM projection  
- `nodata = -9999` pixels are transparent in QGIS or any GIS  
- Pixel values represent the KDE probability density (not normalized counts)

---

## Choosing the masking distance

If you’re using a Gaussian kernel (default), the influence never truly drops to zero.  
We mask density values below 1% of the maximum density.  
An alternative good practical cutoff is **3 × kernel_size**, which retains ~99.7% of the density mass.  
For finite-support kernels (Epanechnikov, cosine, etc.), a cutoff of **1 × kernel_size** can be used.

---

## License

This project is released under the MIT License.  
Feel free to use, modify, and distribute it.

---

## Authors

**Prof. Charles L. Bérubé**  
ΦRe(x) - Polytechnique Montréal  
Montréal, Québec, Canada  
CLI implementation and README file generated by ChatGPT. 
